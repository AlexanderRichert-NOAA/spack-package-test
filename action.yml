# This action.yml provides a GitHub Action for testing modified code
# repositories through their corresponding Spack recipe (or a custom
# copy thereof). It does so by downloading Spack, building the modified
# code through Spack, and running unit tests ("spack install --test").
#
# Alex Richert, April 2024
name: 'Spack package tester'
description: 'Install and test code through Spack'

inputs:
  package-name:
    description: 'Spack package name to be tested (no version number or variants)'
    required: true
  package-version:
    description: 'Version of Spack package to be tested'
    required: false
    default: 'develop'
  package-variants:
    description: 'Variants to apply to package spec'
    required: false
  custom-recipe:
    description: 'Path to custom recipe for package to be tested'
    required: false
    default: 'none'
  dependents-to-test:
    description: 'Spack packages to also run unit tests for (space-delimited list with variants)'
    required: false
  use-build-cache:
    description: 'Create build cache of dependencies and save to GitHub Packages'
    required: false
    default: true
  upload-artifacts:
    description: 'Upload certain logs on job failure (options: always, never, on-failure)'
    required: false
    default: 'on-failure'
  repo-dir:
    description: 'Directory containing modified code to be tested (default is to download automatically)'
    required: false
    default: 'auto'
  spack-ref:
    description: 'Spack tag/branch/commit to use'
    required: false
    default: 'develop'
  cpu-target:
    description: 'Spack CPU target'
    required: false
    default: 'x86_64'
  spack-externals:
    description: 'External packages for Spack to try to use'
    required: false
    default: 'cmake gmake perl'
  spack-compiler:
    description: 'Set spec for Spack compiler (e.g., "gcc@12")'
    required: false
  parallel-jobs:
    description: 'Set number of Spack parallel install jobs ("spack install -j/--jobs")'
    required: false
    default: 2
  spack-root:
    description: 'Spack root directory name'
    required: false
    default: 'spack-root'
  cache-secret:
    description: 'Secret for build cache'
    required: false
  unique-id:
    description: 'Unique ID for artifact name'
    required: false
    default: ${{ github.run_id }}

runs:
  using: "composite"
  steps:

    - name: "Get the updated code if needed"
      uses: actions/checkout@v4
      if: inputs.repo-dir == 'auto'
      with: 
        path: spack-devpkg-${{ inputs.package-name }}

    - name: "Point to existing code if needed"
      if: inputs.repo-dir == 'auto'
      shell: bash
      run: |
        ln -s ${{ inputs.repo-dir }} spack-devpkg-${{ inputs.package-name }}

    - name: "Get Spack"
      uses: spack/setup-spack@v2
      with:
        ref: ${{ inputs.spack-ref }}
        path: ${{ inputs.spack-root }}

    - name: "Update recipe (if needed)"
      if: inputs.custom-recipe != 'none'
      shell: bash
      run: |
        cp ${{ inputs.custom-recipe }} ${SPACK_ROOT}/var/spack/repos/builtin/packages/${{ inputs.package-name }}/package.py

    - name: "Do Spack installation and tests"
      shell: spack-bash {0}
      run: |
        if [ "${{ inputs.use-build-cache }}" == true ]; then
          spack mirror add spack-build-cache oci://ghcr.io/AlexanderRichert-NOAA/spack-build-cache
          spack mirror set --oci-username ${{ github.actor }} --oci-password "${{ inputs.cache-secret }}" spack-build-cache
        fi
        spack env create test
        spack env activate test
        spack develop --no-clone --path ${GITHUB_WORKSPACE}/spack-devpkg-${{ inputs.package-name }} ${{ inputs.package-name }}@${{ inputs.package-version }}
        spack add ${{ inputs.package-name }}@${{ inputs.package-version }} ${{ inputs.package-variants }} target=${{ inputs.cpu-target }} ${{ inputs.dependents-to-test }}
        if [ ! -z "${{ inputs.spack-compiler }}" ]; then
          spack compiler find ${{ inputs.spack-compiler }}
          spack config add "packages:all:require:'%${{ inputs.spack-compiler }}'"
        fi
        if [ ! -z "${{ inputs.spack-externals }}" ]; then spack external find ${{ inputs.spack-externals }}; fi
        spack concretize 2> ${GITHUB_WORKSPACE}/spack-concretize-err.log 1> ${GITHUB_WORKSPACE}/spack-concretize-out.log
        cat ${GITHUB_WORKSPACE}/spack-concretize-out.log
        realpath ${SPACK_ENV}/spack.yaml
        spack install --jobs ${{ inputs.parallel-jobs }} --test root --no-check-signature

    - name: "Update Spack build cache"
      if: inputs.use-build-cache
      shell: spack-bash {0}
      run: |
        spack buildcache push --update-index --only dependencies --unsigned spack-build-cache ${{ inputs.package-name }}

    - name: "Generate unique ID"
      if: ( failure() && inputs.upload-artifacts == 'on-failure' ) || inputs.upload-artifacts == 'always'
      shell: bash
      run: |
        if [ -z ${{ inputs.unique-id }} ]; then
          uniqid='${{ github.sha }}-${{ github.run_id }}-${{ github.run_attempt }}-${{ inputs.package-name }}-${{ inputs.package-version }}-${{ inputs.package-variants }}'
          uniqid="$uniqid$(date +%s.%N)"
          uniqid=$(echo $uniqid | md5sum | awk '{print $1}')
        else
          uniqid=${{ inputs.unique-id }}
        fi
        echo "export uniqid=$uniqid" >> $GITHUB_ENV

    - name: "Upload various debug info"
      uses: actions/upload-artifact@v4
      if: ( failure() && inputs.upload-artifacts == 'on-failure' ) || inputs.upload-artifacts == 'always'
      with:
        name: spack-package-test-artifacts-${{ env.uniqid }}
        path: |
          ${{ github.workspace }}/${{ inputs.spack-root }}/var/spack/environments/test/spack.yaml
          ${{ github.workspace }}/spack-concretize-out.log
          ${{ github.workspace }}/spack-concretize-err.log
